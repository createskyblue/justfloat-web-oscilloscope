# JustFloat 协议 Web 示波器 - 功能说明书

## 1. 项目概述

### 1.1 项目背景
这是一个基于Web的示波器应用，用于实时显示和分析来自JustFloat协议设备的数据。该应用通过Web Serial API与设备通信，解析数据并以图表形式实时展示。

### 1.2 目标用户
- 工程师和技术人员，需要实时监测和分析设备数据
- 研发团队，需要调试和验证设备协议
- 对数据可视化感兴趣的开发者

### 1.3 核心功能
- 通过串口连接设备并接收数据
- 解析JustFloat协议数据
- 实时绘制多通道波形图
- 提供数据分析和统计功能
- 支持数据导入/导出

## 2. 系统功能详述

### 2.1 串口连接管理
- 支持通过Web Serial API连接设备
- 显示连接状态（未连接、连接中、已连接、错误）
- 可配置波特率（默认115200）
- 断开连接功能

### 2.2 数据解析模块
- 实现JustFloat协议解析器
- 协议格式：[float ch1, ..., float chN, 0x00, 0x00, 0x80, 0x7F]
- 通过同步字[0x00, 0x00, 0x80, 0x7F]识别帧边界
- 支持多通道数据解析

#### 2.2.1 协议解析详细流程
- **数据接收**：将串口接收到的原始字节数据（Uint8Array）依次添加到一个接收队列/缓冲区
- **状态机解析**：使用逐字节+状态机的方式进行协议解析
  1. 初始化状态：寻找第一个协议尾 [0x00, 0x00, 0x80, 0x7F]
  2. 当找到第一个协议尾后，继续寻找第二个协议尾
  3. 一旦找到第二个协议尾，将两个协议尾之间的数据视为有效负载
  4. 验证数据长度是否为4的倍数（因为float类型占4字节），如果不是，则继续查找下一个协议尾
  5. 将有效负载按每4个字节一组解释为little endian格式的float值
  6. 将解析出的一组float值打包成数组，放入待处理队列
  7. 将数据指针移动到第二个协议尾位置，继续解析后续数据
- **数据输出**：将解析后的多通道float数组传递给数据处理模块

### 2.3 实时数据显示
- 多通道波形图展示
- 支持至少8种不同颜色区分通道
- 实时更新显示（约30fps）
- 自适应Y轴范围

### 2.4 数据缓冲管理
- 可配置的缓冲区大小（最小1000点）
- 循环缓冲区，超出容量时自动丢弃旧数据
- 内存使用优化，防止内存泄漏

### 2.5 通道配置
- 每个通道可独立设置：
  - 名称（默认"通道 X"）
  - 单位（如V, A, °C等）
  - 系数（用于数值转换）
  - 可见性开关
- 通道状态实时监控（最小值、最大值、平均值）

### 2.6 工具功能
- 统计模式：选择区域并计算统计数据
- 缩放模式：放大查看特定区域
- 重置视图功能

### 2.7 数据分析
- 选中区域的数据统计（最小值、最大值、平均值）
- 计算采样率
- 显示选中区域的时间长度和频率

### 2.8 数据管理
- 支持导入/导出数据（JSON格式）
- 清除当前显示数据
- 会话采样率显示

## 3. 性能要求和优化策略

### 3.1 内存管理
- **关键要求**：严格限制内存使用，防止内存泄漏
- 使用循环缓冲区，及时丢弃超出容量的旧数据
- 避免使用`splice()`方法，改用`slice()`创建新数组引用
- 在组件卸载时正确清理资源（定时器、动画帧等）

### 3.2 渲染性能
- 当数据点超过100,000个时，实施数据切片显示机制
- 对于超过300,000个数据点，延长刷新间隔至1000ms
- 仅渲染可视区域内的数据点
- 优化图表更新频率（默认32ms刷新一次）

### 3.3 数据处理性能
- 高频数据流需实施分批处理机制
- 单次处理不超过1000个数据点
- 优先保留最新数据
- 控制缓冲区总长度在合理范围内

### 3.4 状态管理
- 正确使用React Hooks依赖数组
- 在useEffect清理函数中取消所有定时器和动画帧
- 避免因依赖数组不完整导致的状态过时问题

## 4. 技术架构

### 4.1 前端技术栈
- Vite（快速构建工具）
- Tailwind CSS（样式框架）
- uPlot（高性能图表库）


### 4.3 数据流向
1. 通过Web Serial API接收原始字节数据
2. 传递给协议解析器进行解包
3. 解析后的数据存储在循环缓冲区中
4. 经过变换（系数调整）后传给图表组件
5. 图表组件实时渲染波形

## 5. 用户界面设计

### 5.1 主界面布局
- 顶部：标题、导入/导出/清除按钮、连接状态、连接按钮
- 左侧：参数配置面板（波特率、缓冲区大小）和通道状态监控
- 中央：主波形显示区域
- 底部：状态栏（连接状态、当前索引、数据量等）

### 5.2 交互功能
- 鼠标悬停显示具体数值
- 区域选择进行统计分析
- 缩放和平移功能
- 工具栏切换不同操作模式

## 6. 配置与持久化

### 6.1 本地存储
- 将配置信息保存到localStorage
- 包括：波特率、缓冲区大小、通道配置等
- 遵循最小缓冲区大小限制（1000点）

### 6.2 数据导出
- 支持将当前数据显示的数据导出为JSON格式
- 包含配置、数据和采样率信息
- 便于后续分析或分享

## 7. 错误处理与稳定性

### 7.1 异常处理
- 串口连接异常处理
- 协议解析错误处理
- 图表渲染异常处理
- 内存溢出保护机制

### 7.2 稳定性保障
- 防止长时间运行导致的性能下降
- 确保在各种数据输入下的稳定性
- 提供用户友好的错误提示

### 8 权限管理
- 正确处理Web Serial API权限请求
- 提供清晰的权限使用说明